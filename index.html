<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poker Hand Review Memo</title>
    <style>
        /* 最適化されたカスタムCSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #111827;
            color: #e5e7eb;
            line-height: 1.6;
        }
        
        /* レイアウト */
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 1rem;
            width: 100%;
            box-sizing: border-box;
        }
        
        @media (min-width: 640px) {
            .container { padding: 1.5rem; }
        }
        
        @media (min-width: 1024px) {
            .container { padding: 2rem; }
        }
        
        /* ヘッダー */
        header {
            background-color: #6b21a8;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        header h1 {
            color: white;
            text-align: center;
            font-size: 1.875rem;
            font-weight: bold;
            padding: 1rem;
        }
        
        /* メインコンテンツ */
        main {
            padding: 1rem;
        }
        
        @media (min-width: 640px) {
            main { padding: 1.5rem; }
        }
        
        @media (min-width: 1024px) {
            main { padding: 2rem; }
        }
        
        /* カード */
        .card-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 70px;
            background-color: #374151;
            border: 2px dashed #4B5563;
            border-radius: 4px;
            font-size: 2rem;
            color: #6B7280;
        }
        
        .card-display {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 70px;
            background-color: #F9FAFB;
            border: 1px solid #4B5563;
            border-radius: 4px;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .card-sprite {
            width: 40px;
            height: 63px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            font-weight: bold;
            letter-spacing: 0.02em;
            color: #000;
            background: #fff;
            border: 1px solid #4B5563;
            border-radius: 4px;
            transition: border-color 0.2s;
            box-sizing: border-box;
            cursor: pointer;
        }
        
        .card-sprite:hover:not(.selected):not(.disabled) {
            border-color: #9333ea;
        }
        
        .card-sprite.selected {
            border-color: #a78bfa;
            box-shadow: 0 0 8px rgba(167, 139, 250, 0.7);
            background-color: #4A008B;
        }
        
        .card-sprite.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            filter: grayscale(80%);
            pointer-events: none;
        }
        
        .card-sprite.heart, .card-sprite.diamond {
            color: #ef4444;
        }
        
        .card-grid {
            display: grid;
            grid-template-columns: repeat(13, 1fr);
            column-gap: 1px;
            row-gap: 2px;
            justify-content: start;
            align-items: start;
        }
        
        /* フォーム要素 */
        .form-group {
            margin-bottom: 2rem;
        }
        
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #d1d5db;
            margin-bottom: 0.25rem;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            background-color: #374151;
            border: 1px solid #4B5563;
            border-radius: 0.375rem;
            padding: 0.5rem;
            color: #e5e7eb;
            box-sizing: border-box;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #a855f7;
            box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.2);
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* グリッドレイアウト */
        .grid {
            display: grid;
            gap: 1rem;
        }
        
        .grid-cols-1 { grid-template-columns: repeat(1, 1fr); }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        
        @media (min-width: 768px) {
            .md\:grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        }
        
        /* ボタン */
        .btn, .btn-primary, .btn-secondary, .btn-sm {
            display: inline-block;
            padding: 0.5rem 1.2rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            text-decoration: none;
            outline: none;
        }
        .btn-primary {
            background: #a855f7;
            color: #fff;
        }
        .btn-primary:hover {
            background: #9333ea;
        }
        .btn-secondary {
            background: #6b7280;
            color: #fff;
        }
        .btn-secondary:hover {
            background: #4b5563;
        }
        .btn-sm {
            padding: 0.25rem 0.8rem;
            font-size: 0.95rem;
        }
        /* コピー用ボタンも統一 */
        #copy-memo {
            min-width: 70px;
            height: 32px;
            line-height: 32px;
            white-space: nowrap;
            overflow: hidden;
            box-sizing: border-box;
            font-size: 0.95rem;
        }
        /* セクション */
        .section {
            background-color: rgba(17, 24, 39, 0.5);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .section-title {
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 1rem;
            line-height: 1.2;
        }
        
        .section-content {
            margin-top: 1rem;
        }
        
        /* アクションボタン */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .action-btn {
            padding: 0.25rem 0.5rem;
            border: 1px solid #4B5563;
            background-color: #374151;
            color: #e5e7eb;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.75rem;
        }
        
        .action-btn:hover {
            background-color: #4B5563;
        }
        
        .action-actor {
            padding: 0.25rem 0.5rem;
            border: 1px solid #4B5563;
            background-color: #374151;
            color: #e5e7eb;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.75rem;
        }
        
        .action-actor:hover {
            background-color: #4B5563;
        }
        
        /* ユーティリティ */
        .space-y-6 > * + * {
            margin-top: 1.5rem;
        }
        
        .space-y-4 > * + * {
            margin-top: 1rem;
        }
        
        .space-y-2 > * + * {
            margin-top: 0.5rem;
        }
        
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mt-4 { margin-top: 1rem; }
        
        .flex { display: flex; }
        .gap-2 { gap: 0.5rem; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        
        .h-\[75px\] { height: 75px; }
        
        /* レスポンシブ */
        @media (max-width: 600px) {
            .card-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        .button-row {
            display: flex;
            gap: 16px;
            justify-content: center;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .memo-header-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 1rem;
        }
        .memo-header-row .section-title {
            margin-bottom: 0;
            font-size: 1rem;
            font-weight: 500;
            line-height: 1.2;
        }
        @media (max-width: 600px) {
            .button-row,
            .memo-header-row {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            .button-row button,
            .memo-header-row button {
                width: 100%;
                min-width: 0;
                max-width: 100%;
                box-sizing: border-box;
            }
            .memo-header-row {
                align-items: flex-start;
            }
        }
        #text-memo-content {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            display: block;
            margin: 0;
            padding: 0.75rem 1rem;
        }
    </style>
</head>
<body>

    <header>
        <h1>Poker Hand Review Memo</h1>
    </header>

    <main>
        <div class="container">

            <div class="section">
                <h2 class="section-title">新規メモ作成</h2>

                <form id="hand-memo-form" class="space-y-6">
                    <div class="form-group">
                        <label for="hand-title" class="form-label">ハンドタイトル</label>
                        <input type="text" id="hand-title" name="hand-title" placeholder="例: アグレッシブなヴィランに対するブラフキャッチ" class="form-input">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2">
                        <div class="form-group">
                            <label class="form-label">Heroのポジション</label>
                            <select id="hero-position" class="form-select">
                                <option value="">選択してください</option>
                                <option value="UTG">UTG</option>
                                <option value="UTG+1">UTG+1</option>
                                <option value="MP">MP</option>
                                <option value="MP+1">MP+1</option>
                                <option value="HJ">HJ</option>
                                <option value="CO">CO</option>
                                <option value="BTN">BTN</option>
                                <option value="SB">SB</option>
                                <option value="BB">BB</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Villainのポジション</label>
                            <select id="villain-position" class="form-select">
                                <option value="">選択してください</option>
                                <option value="UTG">UTG</option>
                                <option value="UTG+1">UTG+1</option>
                                <option value="MP">MP</option>
                                <option value="MP+1">MP+1</option>
                                <option value="HJ">HJ</option>
                                <option value="CO">CO</option>
                                <option value="BTN">BTN</option>
                                <option value="SB">SB</option>
                                <option value="BB">BB</option>
                            </select>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <!-- プリフロップ -->
                        <details class="section">
                            <summary class="section-title">プリフロップ</summary>
                            <div class="section-content">
                                <!-- Heroの手札選択 -->
                                <div>
                                    <h4 class="form-label">Heroの手札 (2枚選択)</h4>
                                    <div class="flex gap-2 mb-4 h-[75px] items-center" id="hero-selected-cards-display">
                                        <div class="card-display" style="color: #ef4444;">A♥</div>
                                        <div class="card-display" style="color: #000;">K♠</div>
                                    </div>
                                    <div id="hero-card-grid" class="card-grid"></div>
                                </div>
                                
                                <!-- プリフロップアクション -->
                                <div id="preflop-action-section">
                                    <!-- プリフロップアクションはJavaScriptで動的に生成 -->
                                </div>
                            </div>
                        </details>

                        <!-- フロップ -->
                        <details class="section">
                            <summary class="section-title">フロップ</summary>
                            <div class="section-content">
                                <!-- フロップカード選択 -->
                                <div>
                                    <h4 class="form-label">フロップカード (3枚選択)</h4>
                                    <div class="flex gap-2 mb-4 h-[75px] items-center" id="flop-selected-cards-display">
                                        <div class="card-display" style="color: #000;">Q♠</div>
                                        <div class="card-display" style="color: #ef4444;">J♦</div>
                                        <div class="card-display" style="color: #000;">2♣</div>
                                    </div>
                                    <div id="flop-card-grid" class="card-grid"></div>
                                </div>
                                
                                <!-- フロップアクション -->
                                <div id="flop-action-section">
                                    <!-- フロップアクションはJavaScriptで動的に生成 -->
                                </div>
                            </div>
                        </details>

                        <!-- ターン -->
                        <details class="section">
                            <summary class="section-title">ターン</summary>
                            <div class="section-content">
                                <!-- ターンカード選択 -->
                                <div>
                                    <h4 class="form-label">ターンカード (1枚選択)</h4>
                                    <div class="flex gap-2 mb-4 h-[75px] items-center" id="turn-selected-cards-display">
                                        <div class="card-display" style="color: #000;">A♣</div>
                                    </div>
                                    <div id="turn-card-grid" class="card-grid"></div>
                                </div>
                                
                                <!-- ターンアクション -->
                                <div id="turn-action-section">
                                    <!-- ターンアクションはJavaScriptで動的に生成 -->
                                </div>
                            </div>
                        </details>

                        <!-- リバー -->
                        <details class="section">
                            <summary class="section-title">リバー</summary>
                            <div class="section-content">
                                <!-- リバーカード選択 -->
                                <div>
                                    <h4 class="form-label">リバーカード (1枚選択)</h4>
                                    <div class="flex gap-2 mb-4 h-[75px] items-center" id="river-selected-cards-display">
                                        <div class="card-placeholder">?</div>
                                    </div>
                                    <div id="river-card-grid" class="card-grid"></div>
                                </div>
                                
                                <!-- リバーアクション -->
                                <div id="river-action-section">
                                    <!-- リバーアクションはJavaScriptで動的に生成 -->
                                </div>
                            </div>
                        </details>
                    </div>

                    <div class="form-group">
                        <label for="notes" class="form-label">メモ / 分析</label>
                        <textarea id="notes" name="notes" rows="6" class="form-textarea" placeholder="ハンドに関する詳細な考察、レンジ、プレイヤーの傾向など。"></textarea>
                    </div>

                    <div class="button-row">
                        <button type="button" id="generate-text-memo" class="btn btn-primary">テキストメモ生成</button>
                        <button type="button" class="btn btn-secondary">クリア</button>
                    </div>
                </form>

                <!-- テキストメモ表示エリア -->
                <div id="text-memo-area" class="section hidden">
                    <div class="memo-header-row">
                        <h3 class="section-title" style="margin-bottom:0;">生成されたテキストメモ</h3>
                        <button id="copy-memo" class="btn btn-primary btn-sm">コピー</button>
                    </div>
                    <div id="text-memo-content" class="form-textarea font-mono text-sm whitespace-pre-wrap max-h-96 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // カードのスートとランクの定義
        const SUITS = ['s', 'h', 'd', 'c']; // スペード、ハート、ダイヤ、クラブ
        const RANKS = ['A', '2', '3', '4', '5', '6', '7', '8', '9', 'T', 'J', 'Q', 'K'];

        // 各カードのデータ (スプライトシート上の位置情報も含む)
        const ALL_CARDS = [];
        const CARD_WIDTH = 71; // スプライトシート上の1枚あたりのカードの幅 (px)
        const CARD_HEIGHT = 96; // スプライトシート上の1枚あたりのカードの高さ (px)

        // スート記号のマッピング
        const SUIT_SYMBOLS = { s: '♠', h: '♥', d: '♦', c: '♣' };

        SUITS.forEach((suit, suitIndex) => {
            RANKS.forEach((rank, rankIndex) => {
                ALL_CARDS.push({
                    id: rank + suit, // 例: 'As', 'Kh'
                    rank: rank,
                    suit: suit,
                    // スプライトシート上の背景位置 (CSSの background-position 用)
                    bgX: -rankIndex * CARD_WIDTH,
                    bgY: -suitIndex * CARD_HEIGHT
                });
            });
        });

        console.log(ALL_CARDS); // コンソールで生成されたカードデータを確認できます

        // カードの表示と選択に関連するHTML要素のID
        const cardGridIds = {
            hero: 'hero-card-grid',
            flop: 'flop-card-grid',
            turn: 'turn-card-grid',
            river: 'river-card-grid'
        };

        const selectedCardsDisplayIds = {
            hero: 'hero-selected-cards-display',
            flop: 'flop-selected-cards-display',
            turn: 'turn-selected-cards-display',
            river: 'river-selected-cards-display'
        };

        // スプライトシートの画像パス
        const SPRITESHEET_PATH = null; // 画像なしでテキスト表示

        // カード選択のロジック
        const SELECTION_LIMITS = {
            hero: 2,    // Heroの手札は2枚
            flop: 3,    // フロップは3枚
            turn: 1,    // ターンは1枚
            river: 1    // リバーは1枚
        };

        // 選択されたカードを管理するオブジェクト
        const selectedCards = {
            hero: [],
            flop: [],
            turn: [],
            river: []
        };

        // アクションシーケンスの定義
        const actionSequences = [
            { id: 'preflop', label: 'プリフロップ' },
            { id: 'flop', label: 'フロップ' },
            { id: 'turn', label: 'ターン' },
            { id: 'river', label: 'リバー' }
        ];

        // ポジションの順序を定義（浅い順）
        const POSITION_ORDER = ['UTG', 'UTG+1', 'MP', 'MP+1', 'HJ', 'CO', 'BTN', 'SB', 'BB'];

        // ポジションが浅い方（早い方）を判定する関数
        function getEarlierPosition(pos1, pos2) {
            const index1 = POSITION_ORDER.indexOf(pos1);
            const index2 = POSITION_ORDER.indexOf(pos2);
            return index1 <= index2 ? pos1 : pos2;
        }

        // プリフロップ用の入力フィールドを追加
        function addPreflopInputs() {
            const container = document.getElementById('preflop-action-section');
            if (!container) return;

            container.innerHTML = `
                <div class="form-group">
                    <label class="form-label">オープンサイズ</label>
                    <input type="number" id="open-size" placeholder="例: 4" min="0" step="0.1" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">アクション</label>
                    <div class="action-buttons">
                        <button type="button" class="action-actor" data-actor="H">Hero</button>
                        <button type="button" class="action-actor" data-actor="V">Villain</button>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="action-btn">X</button>
                        <button type="button" class="action-btn">C</button>
                        <button type="button" class="action-btn action-with-size">B</button>
                        <button type="button" class="action-btn action-with-size">R</button>
                        <button type="button" class="action-btn">F</button>
                    </div>
                    <textarea id="preflop-action" rows="3" class="form-textarea" placeholder="プリフロップのアクションを入力してください..."></textarea>
                </div>
            `;
        }

        // アクションシーケンスを動的に生成する関数
        function generateActionSequences() {
            // フロップ、ターン、リバーのアクションを生成
            actionSequences.filter(sequence => sequence.id !== 'preflop').forEach(sequence => {
                const container = document.getElementById(`${sequence.id}-action-section`);
                if (!container) return;

                container.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">アクション</label>
                        <div class="action-buttons">
                            <button type="button" class="action-actor" data-actor="H">Hero</button>
                            <button type="button" class="action-actor" data-actor="V">Villain</button>
                        </div>
                        <div class="action-buttons">
                            <button type="button" class="action-btn">X</button>
                            <button type="button" class="action-btn">C</button>
                            <button type="button" class="action-btn action-with-size">B</button>
                            <button type="button" class="action-btn action-with-size">R</button>
                            <button type="button" class="action-btn">F</button>
                        </div>
                        <textarea id="${sequence.id}-action" name="${sequence.id}-action" rows="3" class="form-textarea" placeholder="${sequence.label}のアクションを入力してください..."></textarea>
                    </div>
                `;
            });
        }

        // カードをクリックして選択する関数
        function handleCardClick(cardId, section) {
            const cardElement = document.querySelector(`[data-card-id="${cardId}"]`);
            const isSelected = cardElement.classList.contains('selected');
            
            // 選択制限をチェック
            if (!isSelected && selectedCards[section].length >= SELECTION_LIMITS[section]) {
                alert(`${section}は最大${SELECTION_LIMITS[section]}枚まで選択できます`);
                return;
            }

            if (isSelected) {
                // カードの選択を解除
                cardElement.classList.remove('selected');
                selectedCards[section] = selectedCards[section].filter(id => id !== cardId);
            } else {
                // カードを選択
                cardElement.classList.add('selected');
                selectedCards[section].push(cardId);
            }

            // 選択されたカードの表示を更新
            updateSelectedCardsDisplay(section);
            
            // 他のセクションで選択されたカードを無効化/有効化
            updateCardAvailability();
        }

        // 選択されたカードの表示を更新する関数
        function updateSelectedCardsDisplay(section) {
            const displayElement = document.getElementById(selectedCardsDisplayIds[section]);
            if (!displayElement) return;

            displayElement.innerHTML = '';

            selectedCards[section].forEach(cardId => {
                const card = ALL_CARDS.find(c => c.id === cardId);
                if (card) {
                    const cardDiv = document.createElement('div');
                    cardDiv.classList.add('card-display');
                    cardDiv.style.color = (card.suit === 'h' || card.suit === 'd') ? '#ef4444' : '#000';
                    cardDiv.textContent = `${card.rank}${SUIT_SYMBOLS[card.suit]}`;
                    displayElement.appendChild(cardDiv);
                }
            });

            // プレースホルダーを追加（選択可能な枚数まで）
            const remainingSlots = SELECTION_LIMITS[section] - selectedCards[section].length;
            for (let i = 0; i < remainingSlots; i++) {
                const placeholderDiv = document.createElement('div');
                placeholderDiv.classList.add('card-placeholder');
                placeholderDiv.textContent = '?';
                displayElement.appendChild(placeholderDiv);
            }
        }

        // カードの選択可能性を更新する関数
        function updateCardAvailability() {
            // すべての選択されたカードのIDを取得
            const allSelectedCardIds = [
                ...selectedCards.hero,
                ...selectedCards.flop,
                ...selectedCards.turn,
                ...selectedCards.river
            ];

            // すべてのカード要素を取得
            const allCardElements = document.querySelectorAll('.card-sprite');
            
            allCardElements.forEach(cardElement => {
                const cardId = cardElement.dataset.cardId;
                const isSelected = allSelectedCardIds.includes(cardId);
                
                if (isSelected) {
                    cardElement.classList.add('disabled');
                } else {
                    cardElement.classList.remove('disabled');
                }
            });
        }

        // カードを生成して指定されたグリッドに追加する関数（最適化版）
        function renderCardGrid(gridElementId) {
            const gridElement = document.getElementById(gridElementId);
            if (!gridElement) {
                console.error(`Grid element with ID ${gridElementId} not found.`);
                return;
            }
            
            // 既に生成済みの場合はスキップ
            if (gridElement.children.length > 0) return;
            
            gridElement.innerHTML = '';
            
            // 画面幅で分岐
            const isMobile = window.innerWidth <= 600;
            const cards = isMobile ? 
                // スマホ：スートごと4列×13行
                RANKS.flatMap(rank => SUITS.map(suit => ({ rank, suit }))) :
                // PC：ランクごと13列×4行
                SUITS.flatMap(suit => RANKS.map(rank => ({ rank, suit })));
            
            // DocumentFragmentを使用してDOM操作を最適化
            const fragment = document.createDocumentFragment();
            
            cards.forEach(({ rank, suit }) => {
                const card = ALL_CARDS.find(c => c.rank === rank && c.suit === suit);
                if (!card) return;
                
                const cardDiv = document.createElement('div');
                cardDiv.classList.add('card-sprite');
                cardDiv.dataset.cardId = card.id;
                if (card.suit === 'h') cardDiv.classList.add('heart');
                if (card.suit === 'd') cardDiv.classList.add('diamond');
                cardDiv.textContent = `${card.rank}${SUIT_SYMBOLS[card.suit]}`;
                fragment.appendChild(cardDiv);
            });
            
            gridElement.appendChild(fragment);
            gridElement.style.gridTemplateColumns = isMobile ? 'repeat(4, 1fr)' : 'repeat(13, 1fr)';
        }

        // アクションボタンの機能（最適化版）
        function setupActionButtons() {
            // イベント委譲でカードクリックを処理
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('card-sprite')) {
                    const cardId = e.target.dataset.cardId;
                    const gridId = e.target.closest('.card-grid').id;
                    const section = Object.keys(cardGridIds).find(key => cardGridIds[key] === gridId);
                    
                    if (!e.target.classList.contains('disabled')) {
                        handleCardClick(cardId, section);
                    }
                }
                
                // アクションボタンの処理
                if (e.target.matches('.action-btn')) {
                    e.preventDefault();
                    const button = e.target;
                    const buttonText = button.textContent.trim();
                    
                    if (['X', 'C', 'B', 'R', 'F'].includes(buttonText)) {
                        const actionText = buttonText;
                        const inputField = button.closest('[id$="-action-section"]')?.querySelector('textarea');
                        
                        if (inputField) {
                            if (button.classList.contains('action-with-size')) {
                                const size = prompt(`${actionText}のサイズを入力してください（例: 50）`);
                                if (size !== null && size.trim() !== '') {
                                    const currentValue = inputField.value;
                                    const sizeWithUnit = (actionText === 'R' && inputField.id === 'preflop-action') ?
                                        (size.includes('bb') ? size : size + 'bb') :
                                        (size.includes('%') ? size : size + '%');
                                    
                                    const separator = currentValue ? ', ' : '';
                                    const newValue = currentValue + separator + actionText + sizeWithUnit;
                                    inputField.value = newValue;
                                    inputField.focus();
                                }
                            } else {
                                const currentValue = inputField.value;
                                const separator = currentValue ? ', ' : '';
                                const newValue = currentValue + separator + actionText;
                                inputField.value = newValue;
                                inputField.focus();
                            }
                        }
                    }
                }
            });
        }

        // アクション主体ボタンの機能
        function setupActionActorButtons() {
            // 動的に生成されたボタンにイベントリスナーを追加
            document.addEventListener('click', (e) => {
                if (e.target.matches('.action-actor')) {
                    e.preventDefault();
                    
                    const button = e.target;
                    const actor = button.dataset.actor; // H または V
                    
                    // ボタンから適切なtextareaを探す
                    let inputField = null;
                    
                    // まず、ボタンが含まれるアクションセクションを探す
                    const actionSection = button.closest('[id$="-action-section"]');
                    if (actionSection) {
                        // アクションセクション内のtextareaを探す
                        inputField = actionSection.querySelector('textarea');
                    }
                    
                    // 見つからない場合は、ボタンの親要素から再帰的に探す
                    if (!inputField) {
                        let parent = button.parentElement;
                        while (parent && !inputField) {
                            inputField = parent.querySelector('textarea');
                            parent = parent.parentElement;
                        }
                    }
                    
                    if (inputField) {
                        const currentValue = inputField.value;
                        const actorText = actor === 'H' ? 'Hero' : 'Villain';
                        
                        // 既存の値がある場合は改行を追加
                        const separator = currentValue ? '\n' : '';
                        const newValue = currentValue + separator + actorText + ': ';
                        inputField.value = newValue;
                        inputField.focus();
                    } else {
                        console.error('textareaが見つかりませんでした');
                    }
                }
            });
        }

        // フォームのクリア機能
        function setupClearButton() {
            const clearButtons = document.querySelectorAll('button[type="button"]');
            clearButtons.forEach(button => {
                if (button.textContent === 'クリア') {
                    button.addEventListener('click', () => {
                        if (confirm('すべての入力内容をクリアしますか？')) {
                            clearAllData();
                        }
                    });
                }
            });
        }

        // すべてのデータをクリアする関数
        function clearAllData() {
            // 選択されたカードをクリア
            Object.keys(selectedCards).forEach(section => {
                selectedCards[section] = [];
                updateSelectedCardsDisplay(section);
            });
            
            // カードの選択状態をリセット
            document.querySelectorAll('.card-sprite').forEach(card => {
                card.classList.remove('selected', 'disabled');
            });
            
            // 入力フィールドをクリア
            document.getElementById('hand-title').value = '';
            actionSequences.forEach(sequence => {
                const element = document.getElementById(`${sequence.id}-action`);
                if (element) {
                    element.value = '';
                }
            });
            document.getElementById('notes').value = '';
            document.getElementById('hero-position').value = '';
            document.getElementById('villain-position').value = '';
            
            // カードの選択可能性を更新
            updateCardAvailability();
        }



        // カードIDから表示用テキストに変換する関数
        function getCardDisplayText(cardId) {
            const card = ALL_CARDS.find(c => c.id === cardId);
            if (card) {
                return `${card.rank}${SUIT_SYMBOLS[card.suit]}`;
            }
            return cardId;
        }

        // テキストメモ用の新しい表記関数（アルファベット表記・最適化版）
        const TEXT_SYMBOLS = { s: 's', h: 'h', d: 'd', c: 'k' };
        const cardTextCache = new Map();
        
        function getCardTextMemoText(cardId) {
            // キャッシュをチェック
            if (cardTextCache.has(cardId)) {
                return cardTextCache.get(cardId);
            }
            
            const card = ALL_CARDS.find(c => c.id === cardId);
            if (card) {
                const text = `${card.rank}${TEXT_SYMBOLS[card.suit]}`;
                cardTextCache.set(cardId, text);
                return text;
            }
            return cardId;
        }

        // テキストメモを生成する関数（最適化版）
        function generateTextMemo() {
            // DOM要素をキャッシュ
            const elements = {
                handTitle: document.getElementById('hand-title'),
                heroPosition: document.getElementById('hero-position'),
                villainPosition: document.getElementById('villain-position'),
                openSize: document.getElementById('open-size'),
                preflopAction: document.getElementById('preflop-action'),
                notes: document.getElementById('notes')
            };
            
            // 値を取得（nullチェック付き）
            const values = {
                handTitle: elements.handTitle?.value || '',
                heroPosition: elements.heroPosition?.value || '',
                villainPosition: elements.villainPosition?.value || '',
                openSize: elements.openSize?.value || '',
                preflopAction: elements.preflopAction?.value || '',
                notes: elements.notes?.value || ''
            };
            
            // カード情報を取得
            const heroCards = selectedCards.hero.map(getCardTextMemoText).join('');
            const flopCards = selectedCards.flop.map(getCardTextMemoText).join('');
            const turnCard = selectedCards.turn.length > 0 ? getCardTextMemoText(selectedCards.turn[0]) : '';
            const riverCard = selectedCards.river.length > 0 ? getCardTextMemoText(selectedCards.river[0]) : '';
            
            // アクション情報を取得（一度に取得）
            const actions = {};
            const actionElements = ['flop', 'turn', 'river'].map(id => ({
                id,
                element: document.getElementById(`${id}-action`)
            }));
            
            actionElements.forEach(({ id, element }) => {
                if (element) {
                    actions[id] = element.value;
                }
            });
            
            // 文字列連結を最適化（配列を使用）
            const memoParts = [];
            
            // ハンドタイトル
            if (values.handTitle.trim()) {
                memoParts.push(values.handTitle, '\n\n');
            }
            
            // ポジション情報
            if (values.heroPosition && values.villainPosition) {
                memoParts.push(`Hero: ${values.heroPosition}, Villain: ${values.villainPosition}`, '\n\n');
            }
            
            // プリフロップ
            if (heroCards || values.openSize || values.preflopAction) {
                memoParts.push('=== Preflop ===\n');
                
                if (heroCards) {
                    memoParts.push(`Hero ${heroCards}\n`);
                }
                
                if (values.openSize) {
                    const earlierPosition = getEarlierPosition(values.heroPosition, values.villainPosition);
                    const sizeWithBb = values.openSize.includes('bb') ? values.openSize : values.openSize + 'bb';
                    
                    if (earlierPosition === values.heroPosition) {
                        memoParts.push(`${values.heroPosition} ${sizeWithBb}\n`);
                    } else {
                        memoParts.push(`${values.villainPosition} ${sizeWithBb}\n`);
                    }
                }
                
                if (values.preflopAction) {
                    memoParts.push(values.preflopAction, '\n');
                }
                memoParts.push('\n');
            }
            
            // フロップ
            if (flopCards) {
                memoParts.push('=== Flop ===\n', flopCards, '\n');
                if (actions.flop) {
                    memoParts.push(actions.flop, '\n');
                }
                memoParts.push('\n');
            }
            
            // ターン
            if (turnCard) {
                memoParts.push('=== Turn ===\n', turnCard, '\n');
                if (actions.turn) {
                    memoParts.push(actions.turn, '\n');
                }
                memoParts.push('\n');
            }
            
            // リバー
            if (riverCard) {
                memoParts.push('=== River ===\n', riverCard, '\n');
                if (actions.river) {
                    memoParts.push(actions.river, '\n');
                }
                memoParts.push('\n');
            }
            
            // メモ内容
            if (values.notes.trim()) {
                memoParts.push('=== Notes ===\n', values.notes, '\n');
            }
            
            return memoParts.join('');
        }

        // テキストメモ生成ボタンの機能（最適化版）
        function setupTextMemoGeneration() {
            const generateButton = document.getElementById('generate-text-memo');
            const memoArea = document.getElementById('text-memo-area');
            const memoContent = document.getElementById('text-memo-content');
            
            if (generateButton) {
                generateButton.addEventListener('click', () => {
                    // ボタンを一時的に無効化して重複クリックを防止
                    generateButton.disabled = true;
                    generateButton.textContent = '生成中...';
                    
                    // 非同期でテキスト生成（UIブロックを防ぐ）
                    setTimeout(() => {
                        const memoText = generateTextMemo();
                        memoContent.textContent = memoText;
                        memoArea.classList.remove('hidden');
                        
                        // ボタンを復元
                        generateButton.disabled = false;
                        generateButton.textContent = 'テキストメモ生成';
                    }, 0);
                });
            }
        }

        // コピー機能（ゼロ幅スペース挿入版）
        function insertZeroWidthSpaceToUrls(text) {
            // URLとメールアドレスの直後にゼロ幅スペースを挿入
            // URL: http(s)://... や www. で始まるもの
            const urlPattern = /(https?:\/\/|www\.)[\w\-._~:/?#[\]@!$&'()*+,;=%]+/g;
            // メールアドレス
            const mailPattern = /[\w.-]+@[\w.-]+\.[A-Za-z]{2,}/g;
            return text
                .replace(urlPattern, m => m + '\u200B')
                .replace(mailPattern, m => m + '\u200B');
        }
        function setupCopyFunction() {
            const copyButton = document.getElementById('copy-memo');
            if (copyButton) {
                copyButton.addEventListener('click', async () => {
                    const memoContent = document.getElementById('text-memo-content');
                    let textToCopy = memoContent.textContent;
                    // ゼロ幅スペースを挿入
                    textToCopy = insertZeroWidthSpaceToUrls(textToCopy);
                    copyButton.disabled = true;
                    const originalText = copyButton.textContent;
                    try {
                        await navigator.clipboard.writeText(textToCopy);
                        copyButton.textContent = 'コピー完了！';
                        copyButton.style.backgroundColor = '#059669';
                        setTimeout(() => {
                            copyButton.textContent = originalText;
                            copyButton.style.backgroundColor = '';
                            copyButton.disabled = false;
                        }, 2000);
                    } catch (err) {
                        console.error('コピーに失敗しました:', err);
                        copyButton.textContent = 'コピー失敗';
                        copyButton.style.backgroundColor = '#dc2626';
                        setTimeout(() => {
                            copyButton.textContent = originalText;
                            copyButton.style.backgroundColor = '';
                            copyButton.disabled = false;
                        }, 2000);
                    }
                });
            }
        }



        // ページロード時にカードグリッドをレンダリング
        document.addEventListener('DOMContentLoaded', () => {
            // プリフロップ入力フィールドを追加
            addPreflopInputs();
            
            // アクションシーケンスを生成
            generateActionSequences();
            
            // Heroの手札用グリッドをレンダリング
            renderCardGrid(cardGridIds.hero);
            // フロップ用グリッドをレンダリング
            renderCardGrid(cardGridIds.flop);
            // ターン用グリッドをレンダリング
            renderCardGrid(cardGridIds.turn);
            // リバー用グリッドをレンダリング
            renderCardGrid(cardGridIds.river);

            // 初期表示を設定
            Object.keys(selectedCardsDisplayIds).forEach(section => {
                updateSelectedCardsDisplay(section);
            });

            // アクションボタンの設定
            setupActionButtons();
            
            // アクション主体ボタンの設定
            setupActionActorButtons();
            
            // クリアボタンの設定
            setupClearButton();
            

            
            // テキストメモ生成の設定
            setupTextMemoGeneration();
            
            // コピー機能の設定
            setupCopyFunction();
        });
    </script>
</body>
</html>